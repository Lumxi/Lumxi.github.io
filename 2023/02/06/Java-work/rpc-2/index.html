<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="从零开始实现一个简单的RPC框架(2), 后端工程师之路">
    <meta name="description" content="1. Socket通信实战什么是Socket
在计算机网络中,Socket被描述为一个抽象的关键字,由IP+port组成,它描述了TCP连接的一个对等端
如果要通过互联网进行通信,则至少需要一对套接字

运行于服务器的Server Sock">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>从零开始实现一个简单的RPC框架(2) | 后端工程师之路</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">后端工程师之路</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">后端工程师之路</div>
        <div class="logo-desc">
            
            华南农业大学软件工程学生博客
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/18.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">从零开始实现一个简单的RPC框架(2)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Java/">
                                <span class="chip bg-color">Java</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/java%E5%9F%BA%E7%A1%80/" class="post-category">
                                java基础
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-02-06
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-Socket通信实战"><a href="#1-Socket通信实战" class="headerlink" title="1. Socket通信实战"></a>1. Socket通信实战</h2><p><strong>什么是Socket</strong></p>
<p>在计算机网络中,<code>Socket</code>被描述为一个抽象的关键字,由<code>IP+port</code>组成,它描述了<code>TCP</code>连接的一个对等端</p>
<p>如果要通过互联网进行通信,则至少需要一对套接字</p>
<ul>
<li>运行于服务器的<code>Server Socket</code></li>
<li>运行于客户端的<code>Client Server</code></li>
</ul>
<p><img src="data:image/png;base64,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"></p>
<p>这个图描述了<code>TCP</code>三次握手-&gt;传输数据-&gt;<code>TCP</code>四次挥手的过程</p>
<p><code>client</code>实际上并不需要指定端口,因为有默认端口的设定,它会在<code>TCP</code>的首部中进行描述,而它需要指定的是,你这个消息要发往哪个目的主机和哪个端口,这样对方的服务器才能够通过此端口接收数据</p>
<p><code>server</code>需要选择监听哪个端口,才能正确接收数据,由于发过来的<code>TCP</code>报文段中具有对方的源地址和源端口信息,因此在回送的时候可以直接根据头部信息获取回送的路径</p>
<p><strong>BIO:简单的EchoServer实现</strong></p>
<p>BIO的实现思路是使用阻塞式的IO输入,只有当双方都完成IO后,连接才会断开,阻塞的时机是在<code>accept()</code>中,只有当接收到数据后,线程才会继续向下执行代码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2. 通过accept监听客户端发送过来的请求</span>
<span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//3. 通过输入流读取客户端发送过来的信息</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端已经连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> message <span class="token operator">=</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到的信息是&#123;&#125;"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4. 通过输出流回送信息</span>
    objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果要进行修正,那么可以引入一个线程池</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">EchoServerTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 服务端开始监听
 * @param port
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//1. 创建ServerSocket,并且监听一个端口</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 通过accept监听客户端发送过来的请求</span>
        <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"处理的线程ID是&#123;&#125;"</span><span class="token punctuation">,</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3. 通过输入流读取客户端发送过来的信息</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端已经连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> message <span class="token operator">=</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到的信息是&#123;&#125;"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4. 通过输出流回送信息</span>
            objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//1.创建线程池</span>
    <span class="token class-name">ThreadFactory</span> threadFactory <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"创建新的线程,线程ID：&#123;&#125;"</span><span class="token punctuation">,</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">start</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>BIO的最大痛点是:处理线程和请求数是1:1的出现的,其关键在于监听请求和处理请求都是同一个线程完成的</p>
<p>尽管引入了线程池,但是当线程数量过多的时候,也会导致程序的崩溃,因此我们应该尽可能的减少线程的使用,一个办法是将监听请求的线程和处理请求的线程给解耦,有一个线程专门负责请求的接收,然后将此请求分发到下面的子线程进行处理</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"处理的线程ID是&#123;&#125;"</span><span class="token punctuation">,</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3. 通过输入流读取客户端发送过来的信息</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端已经连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> message <span class="token operator">=</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到的信息是&#123;&#125;"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4. 通过输出流回送信息</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>经过我自己的测试,当线程数达到十万级别的时候,CPU飙到了百分之90,而这仅仅只是传送一个<code>end</code>而已,而且还有很多请求被丢掉了,性能实在太差</p>
<p>于是引入了<code>NIO</code></p>
<h2 id="2-Netty入门实战"><a href="#2-Netty入门实战" class="headerlink" title="2. Netty入门实战"></a>2. Netty入门实战</h2><p><code>Netty</code>成功找到了一种方式,使得在不妥协可维护性和性能情况下实现易于开发,性能,稳定性和灵活性的方式</p>
<p>首先定义<code>RPC</code>通信对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> interfaceName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> methodName<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>初始化客户端程序</strong></p>
<p>客户端的职责:用一个向服务端发送消息的<code>sendMessage()</code>方法,通过此方法可以将消息也就是<code>RpcRequest</code>对象发送到服务端,并且可以同步获取到服务端返回的结构,也就是<code>RpcResponse</code></p>
<p>我们来看看初始化的时候,都做了一些什么:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Bootstrap</span> b<span class="token punctuation">;</span>

<span class="token comment">//初始化相关资源</span>
<span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">EventLoopGroup</span> eventLoopGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始化序列化器</span>
    <span class="token class-name">KryoSerializer</span> kryoSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KryoSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>eventLoopGroup<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">CONNECT_TIMEOUT_MILLIS</span><span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//自定义序列化编码器</span>
                    <span class="token comment">//RpcResponse->ByteBuf</span>
                    socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//ByteBuf->RpcRequest</span>
                    socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有很多不认识的东西,我们先来认识一下这些东西</p>
<p><code>Bootstrap</code>:它是启动引导类,它是客户端&#x2F;服务端启动的时候的辅助类,它的作用是规定了连接的端口以及处理<code>I/O</code>,接收<code>I/O</code>请求的规则,</p>
<p><code>EventLoopGroup</code>:它相当于一个线程组,<code>EventLoop</code>相当于一个处理线程,那么<code>group</code>就相当于一个线程池,Netty用来处理请求的线程就来自于这个参数,就相当于,它是一个施工队,当需要干活的人从里面挑工人出去干活</p>
<p><code>channel</code>:是代表连接的类型,比如说是<code>TCP</code>连接?还是<code>UDP</code>等</p>
<p><code>handler</code>:消息处理器,代表当请求到来的时候如何处理请求,它就类似于工程师,专门设计方案的,设计出来后,交给施工队进行处理,施工队拿着图纸开始施工</p>
<p><code>初始化通道处理器的过程之后再讲</code>,这里先看编码器</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyKryoEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToByteEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Serializer</span> serializer<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> genericClass<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> byteBuf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>genericClass<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//1.将对象转化为Byte</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serialize <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2. 读取消息的长度</span>
            <span class="token keyword">int</span> dataLength <span class="token operator">=</span> serialize<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token comment">//3. 写入消息长度</span>
            byteBuf<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>dataLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4. 写入消息</span>
            byteBuf<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>serialize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyKryoDecoder</span> <span class="token keyword">extends</span> <span class="token class-name">ByteToMessageDecoder</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Serializer</span> serializer<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> genericClass<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">BODY_LENGTH</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> byteBuf<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>byteBuf <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> byteBuf<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token constant">BODY_LENGTH</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//1.读取消息的长度</span>
        byteBuf<span class="token punctuation">.</span><span class="token function">markReaderIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dataLength <span class="token operator">=</span> byteBuf<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.参数校验</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>dataLength <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">||</span> byteBuf<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//3.如果可读的字节数小于消息长度的话也是不合理的</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>dataLength <span class="token operator">></span> byteBuf<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//那么这时候只能放弃解码,重置读指针,还原本次的修改,等待下一次的I/O</span>
            byteBuf<span class="token punctuation">.</span><span class="token function">resetReaderIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>dataLength<span class="token punctuation">]</span><span class="token punctuation">;</span>
        byteBuf<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//反序列化</span>
        <span class="token class-name">Object</span> target <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> genericClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"反序列化完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>技术点:这里解决了粘包和半包的问题</strong></p>
<p>粘包的话会导致消息的长度&lt;字节数组的长度,这里的话用的方案是提供读取长度的方案。</p>
<p>那么为什么<code>Handler</code>上要注册这几个东西呢?</p>
<p>我们先来回顾一下,在连接上,我们到底在做什么?</p>
<p>首先对于客户端而言,它的工作是将<code>自己产生的RpcRequest</code>发送到服务端对吧?</p>
<blockquote>
<p>那么在这个过程中,通道上需要有一个方法支持,它支持将这个对象编码为二进制字符串,因此需要注册<code>Decoder、Encoder</code>方法</p>
</blockquote>
<p>第二个,客户端还需要解码来自于服务端的消息</p>
<blockquote>
<p>因此通道上需要注册一个将二进制字符串为对象的方法</p>
</blockquote>
<p>第三个,客户端获取到了一个响应,那这个响应要放到哪里去?</p>
<blockquote>
<p>一个通道内的数据通常应该是共享的,因此设计了<code>通道域</code>,将通道中的信息放到一个容器中,对于调用方,只要访问这个容器就能取到数据了</p>
</blockquote>
<p>我们可以看到,这上面的三个环节实际上是环环相扣的,也就是每一部分的工作都由专人负责</p>
<p><strong>技术点:使用责任链模式解耦合编码&#x2F;解码&#x2F;数据存取工作</strong></p>
<p>至此,客户端就初始完毕了</p>
<p><strong>接下来是核心部分,就是规定客户端如何收发数据</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">RpcResponse</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span> rpcRequest<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//1.建立连接,并且获取连接对象数据</span>

    <span class="token comment">//2.建立连接成功,向通道中写入数据</span>

    <span class="token comment">//3.监听返回状态</span>

    <span class="token comment">//4.返回信息成功,从通道中取出返回值</span>

    <span class="token comment">//5.返回信息失败,显示错误信息</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>大致流程如上,接下来我们借助于netty进行实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">RpcResponse</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span> rpcRequest<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//1.建立连接,并且获取连接对象数据</span>
        <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//1.1 获取通道描述对象</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//2.建立连接成功,向通道中写入数据,并且监听发送状态</span>
            channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>future <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端成功发送了信息,请求信息是:&#123;&#125;"</span><span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"客户端发送信息失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3.等待服务端返回信息,当信息传递完毕后通道关闭,因此我们监听通道的存活状态</span>
            channel<span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4.通道关闭,数据应当已经写入到了通道域中</span>
            <span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RpcResponse</span><span class="token punctuation">></span></span> key <span class="token operator">=</span> <span class="token class-name">AttributeKey</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">"rpcResponse"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4.返回信息成功,取出返回值</span>
            <span class="token keyword">return</span> channel<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//5.返回信息失败,显示错误信息</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>服务端开发</strong></p>
<p>首先服务端的架构是基于<code>IO多路复用</code>的架构,这个架构的特点是</p>
<ul>
<li>有一个主线程,该主线程负责接收请求,并且把请求分发到下属的工作线程</li>
<li>工作线程完成任务后,将任务结果通知主线程,主线程将结果返回给客户端</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//1.主线程</span>
    <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2.工作者线程</span>
    <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3.序列化器实现</span>
    <span class="token class-name">KryoSerializer</span> kryoSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KryoSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//4.初始化引导器</span>
        <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span>workerGroup<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//注册通道类型</span>
                <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">TCP_NODELAY</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">//注册每一个channel的TCP策略</span>
                <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_KEEPALIVE</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//每一个channel的处理策略</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
                        socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>依然的是有很多东西看不懂,下面一个个的进行解读</p>
<p><strong>为什么客户端的初始化是在静态块中进行初始化,那到服务器上就变成了实例了?</strong></p>
<p>这个与功能有关</p>
<p>客户端的引导器在初始化的时候并不需要知道对方的IP和port,只有当发起调用的时候才需要知道,因此引导器的初始化放在<code>static</code>和<code>实例中</code>均能够完成初始化,选择在<code>static</code>中能够加速首次调用,但是会降低整个服务的启动速度</p>
<p>服务端的引导器在初始化的时候就必须绑定端口号,但是端口号是程序设定的,一般来说,只有在程序准备完毕后才会执行开启服务的调用,如果在类初始化时就开启调用,可能导致错误的发生</p>
<p><strong>child和非child有什么区别?</strong></p>
<p>从架构上来看,是一个主线程下分配若干个子线程去真正的在<code>Channel</code>中处理数据,因此需要额外配置每个子线程的和子通道的处理策略</p>
<p><code>ChannelOption.TCP_NODELAY</code></p>
<p>它意味着开启了Nagle算法,该算法的作用是尽可能快的发送大数据块,减少网络的传输量,这个参数的作用当为true的时候,就开启了<code>Nagle</code>算法</p>
<p><code>ChannelOption.SO_KEEPALIVE</code></p>
<p>它意味着开启了TCP底层的保活机制,避免客户端关闭后占用线程资源</p>
<p><code>ChannelOption.SO_BACKLOG</code></p>
<p>它表示TCP连接队列的数量,如果连接建立频繁,服务器处理新连接比较慢,可以适当调大这个参数</p>
<p><strong>然后是子线程的处理机制我们要怎么设计?</strong></p>
<p>从通道中接收到一个数据,工作是</p>
<ul>
<li>将二进制串解码,还原对象</li>
<li>执行方法</li>
<li>将产生的响应对象编码,发送到通道中</li>
</ul>
<p>于是设计为:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyKryoDecoder</span><span class="token punctuation">(</span>kryoSerializer<span class="token punctuation">,</span> <span class="token class-name">RpcRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyKryoEncoder</span><span class="token punctuation">(</span>kryoSerializer<span class="token punctuation">,</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>初始化完毕,开启服务端</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//绑定监听端口,同步等待绑定成功</span>
<span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//等待服务端监听端口关闭</span>
future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>完整代码</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">netty<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * Netty发起远程调用的服务端
 *
 * @author: 张庭杰
 * @date: 2023年02月03日 16:40
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServer</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">NettyServer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">NettyServer</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//监听端口</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//1.主线程</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.工作者线程</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.序列化器实现</span>
        <span class="token class-name">KryoSerializer</span> kryoSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KryoSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//4.初始化引导器</span>
            <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span>workerGroup<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//注册通道类型</span>
                    <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">TCP_NODELAY</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_KEEPALIVE</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyKryoDecoder</span><span class="token punctuation">(</span>kryoSerializer<span class="token punctuation">,</span> <span class="token class-name">RpcRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyKryoEncoder</span><span class="token punctuation">(</span>kryoSerializer<span class="token punctuation">,</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//绑定监听端口,同步等待绑定成功</span>
            <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//等待服务端监听端口关闭</span>
            future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//关闭后,执行关闭</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>将处理消息的逻辑处理</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//1.获取请求信息</span>
    <span class="token class-name">RpcRequest</span> rpcRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcRequest</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到了信息&#123;&#125;,次数:&#123;&#125;"</span><span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">COUNTER</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2.返回调用信息</span>
    <span class="token comment">//TODO:在本地发起调用...</span>
    <span class="token class-name">RpcResponse</span> rpcResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpcResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"complete!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3.向通道中写回信息</span>
    <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    future<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这一句是对不需要消息的收尾,防止触发<code>GC</code>的时候大量消息在<code>JVM</code>中,导致GC缓慢</p>
<p>测试代码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">NettyServer</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">RpcRequest</span> rpcRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpcRequest<span class="token punctuation">.</span><span class="token function">setInterfaceName</span><span class="token punctuation">(</span><span class="token string">"haha"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpcRequest<span class="token punctuation">.</span><span class="token function">setMethodName</span><span class="token punctuation">(</span><span class="token string">"haha"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">NettyClient</span> nettyClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyClient</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RpcResponse</span> rpcResponse <span class="token operator">=</span> nettyClient<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>测试通过</strong></p>
<h2 id="3-网络传输模块分析"><a href="#3-网络传输模块分析" class="headerlink" title="3. 网络传输模块分析"></a>3. 网络传输模块分析</h2><p>上面通过一个简单的<code>Netty</code>案例实现了一个远程调用,只不过我们还没有真正意义上的去调用远程的方法,因此下面我们进行改造</p>
<h3 id="3-1-完善实体类信息"><a href="#3-1-完善实体类信息" class="headerlink" title="3.1 完善实体类信息"></a>3.1 完善实体类信息</h3><p>我们想要调用一个远程方法,要知道的必选元素有:</p>
<ul>
<li>暴露出来的接口名称</li>
<li>暴露出来的方法名称</li>
<li>方法所需要的参数</li>
<li>方法所需要的参数的类型</li>
</ul>
<p>这些调用一个方法所必须的元素,但是这个实体类有个问题</p>
<blockquote>
<p>当多请求同时发送的时候,这时候响应是几乎同时响应的,那么我怎么知道哪次调用是谁的呢</p>
<p>如果是BIO的话我们不会有这个问题,但是我们目前是NIO。</p>
<p>这里的话我们借鉴<code>HTTP/2</code>中的<code>StreamId</code>的思想,给它添加一个<code>requestId</code>,用来作为一对请求和响应的标识。</p>
</blockquote>
<p>第二个问题,就是当我调用的这个接口,如果有多个实现类,那么我怎么调用到准确的那个实体类呢?</p>
<p>也是添加一个标识字段,名字任意,这里运用了最佳实践中的<code>group</code></p>
<p>第三个问题,当接口的实现类修改了它的实现,而且是一次重大升级,为了保证兼容,服务端提供了两个接口,一个是旧版本的,一个是新版本的,而他们是一个实现类,这时候也要添加一个标识符,我把它叫做<code>version</code></p>
<p>于是,最终设计出来的结果是,UUID是生成的当前的时间戳</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1675615710L</span><span class="token punctuation">;</span>
    <span class="token comment">/** 必选参数类型 **/</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> interfaceName<span class="token punctuation">;</span><span class="token comment">//暴露出来的接口名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> methodName<span class="token punctuation">;</span><span class="token comment">//暴露出来的方法名称</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameters<span class="token punctuation">;</span><span class="token comment">//调用该方法的参数实参</span>
    <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> paraTypes<span class="token punctuation">;</span><span class="token comment">//这些参数的类型</span>

    <span class="token comment">/** 辅助参数类型 **/</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> group<span class="token punctuation">;</span><span class="token comment">//接口的实现类标识</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> version<span class="token punctuation">;</span><span class="token comment">//接口实现方法版本标识</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> requestId<span class="token punctuation">;</span><span class="token comment">//请求ID,类似于HTTP/2中的StreamId</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接着要完成的是响应类的设计</p>
<p>像<code>HTTP</code>响应一样,响应需要有响应头和响应体</p>
<ul>
<li>关于响应头</li>
</ul>
<p>响应头应该包含了常见的信息,比如说:</p>
<p><code>状态码code</code>:本次请求的结果,如200，403，304等</p>
<p><code>请求Id</code>:代表本次响应对应的是哪一次请求</p>
<p><code>消息message</code>:代表本次响应的消息,比如是成功,还是失败</p>
<ul>
<li>关于响应体</li>
</ul>
<p>响应体就是封装回来的数据,由于不确定,我们使用泛型</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcResponse</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1675616430L</span><span class="token punctuation">;</span>
    <span class="token comment">/*必备参数*/</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span><span class="token comment">//响应状态码</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span><span class="token comment">//自定义响应消息,ok?fail?</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span><span class="token comment">//响应体数据</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为了便于结果的封装,我们这里提供了响应成功和响应失败的便捷方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">RpcResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">,</span><span class="token class-name">String</span> requestId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//封装数据</span>
    <span class="token class-name">RpcResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> rpcResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpcResponse<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">RpcResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESSS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpcResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token class-name">RpcResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESSS</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpcResponse<span class="token punctuation">.</span><span class="token function">setRequestId</span><span class="token punctuation">(</span>requestId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        rpcResponse<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> rpcResponse<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">RpcResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token class-name">String</span> requestId<span class="token punctuation">,</span><span class="token class-name">RpcResponseCode</span> rpcResponseCode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">RpcResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> rpcResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpcResponse<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpcResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpcResponse<span class="token punctuation">.</span><span class="token function">setRequestId</span><span class="token punctuation">(</span>requestId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rpcResponse<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-2-基于Socket实现的RPC远程调用"><a href="#3-2-基于Socket实现的RPC远程调用" class="headerlink" title="3.2 基于Socket实现的RPC远程调用"></a>3.2 基于Socket实现的RPC远程调用</h3><p>首先,我们先将暴露出来的接口准备好</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 *
 * @param rpcRequest 请求对象
 * @return Object:返回请求回来的数据
 */</span>
<span class="token class-name">Object</span> <span class="token function">sendRprRequest</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span> rpcRequest<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后我们只需要去实现这个接口就可以了</p>
<p><strong>基于Socket实现客户端</strong></p>
<p>首先我们分析<code>Socket</code>要做什么,它要做的就是将<code>request</code>对象传输到服务端,然后服务端解析,获取解析后的结果再返回就可以了</p>
<blockquote>
<p>那么在这个过程中,我们如果要访问一个服务,那么必然就是要从注册中去查找这个服务,于是在做实际的服务之前,我们必须先定义好查找服务的接口</p>
</blockquote>
<p>第一步:首先规定服务名称的格式,服务名称应该能够起唯一标识的作用,我们根据</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** 必选参数类型 **/</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> interfaceName<span class="token punctuation">;</span><span class="token comment">//暴露出来的接口名称</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> methodName<span class="token punctuation">;</span><span class="token comment">//暴露出来的方法名称</span>
<span class="token keyword">private</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameters<span class="token punctuation">;</span><span class="token comment">//调用该方法的参数实参</span>
<span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> paraTypes<span class="token punctuation">;</span><span class="token comment">//这些参数的类型</span>

<span class="token comment">/** 辅助参数类型 **/</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> group<span class="token punctuation">;</span><span class="token comment">//接口的实现类标识</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> version<span class="token punctuation">;</span><span class="token comment">//接口实现方法版本标识</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> requestId<span class="token punctuation">;</span><span class="token comment">//请求ID,类似于HTTP/2中的StreamId</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>初步规定服务名称的格式为</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">interfaceName/group/version<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>为什么不用<code>method</code>?这是因为这里只是访问它的服务类,方法的调用当信息传递到远程后再决定</p>
</blockquote>
<p>于是我们新定义一个方法,能够组装起每个请求所想要访问的服务名称:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInterfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator<span class="token operator">+</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第二步:定义服务发现的接口与服务查找相关服务</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 通过远程服务名称查找服务
 * @param rpcServiceName
 * @return
 */</span>
<span class="token class-name">InetSocketAddress</span> <span class="token function">lookUpService</span><span class="token punctuation">(</span><span class="token class-name">String</span> rpcServiceName<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第三步:实现客户端接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServiceDiscovery</span> serviceDiscovery<span class="token punctuation">;</span>
<span class="token comment">//先手动实现注入</span>
<span class="token keyword">public</span> <span class="token class-name">SocketRpcClient</span><span class="token punctuation">(</span><span class="token class-name">ServiceDiscovery</span> serviceDiscovery<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serviceDiscovery <span class="token operator">=</span> serviceDiscovery<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/***
 * 通过Socket请求远程服务
 * @param rpcRequest 请求对象
 * @return
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">sendRprRequest</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span> rpcRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//1. 获取远程服务名称</span>

    <span class="token comment">//2. 通过注册中心查找服务</span>

    <span class="token comment">//3. 查找到服务后,通过socket连接发送对象数据</span>

    <span class="token comment">//此时server解析rpcRequest数据后,写入到outputStream中</span>

    <span class="token comment">//4. 获取返回后的结果</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后就是按照这个思路来实现代码了</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">sendRprRequest</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span> rpcRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//1. 获取远程服务名称</span>
    <span class="token class-name">String</span> rpcServiceName <span class="token operator">=</span> rpcRequest<span class="token punctuation">.</span><span class="token function">toServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2. 通过注册中心查找服务</span>
    <span class="token class-name">InetSocketAddress</span> inetSocketAddress <span class="token operator">=</span> serviceDiscovery<span class="token punctuation">.</span><span class="token function">lookUpService</span><span class="token punctuation">(</span>rpcServiceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3. 查找到服务后,通过socket连接发送对象数据</span>
    <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//3.1 连接到远程服务器,并且将当前对象写入到对方的缓存区中</span>
        socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.2 获取输出流,输出对象到对方</span>
        <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.3 此时server解析rpcRequest数据后,写入到outputStream中</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4. 获取返回后的结果</span>
        result <span class="token operator">=</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>基于Socket实现服务端</strong></p>
<p>要实现服务端,首先这个服务端要先注册自己的服务到注册中心上并且发布,于是我们定义一个服务注册的实现类</p>
<p>这一步比较复杂,涉及到整个注册中心以及服务调用的流程</p>
<h3 id="3-3-定义注册中心基本结构"><a href="#3-3-定义注册中心基本结构" class="headerlink" title="3.3 定义注册中心基本结构"></a>3.3 定义注册中心基本结构</h3><p>这一步非常关键,是我们理解整个注册中心机制的过程,我们先画个图理一下思路</p>
<p><img src="data:image/png;base64,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"></p>
<p>我们建立的过程是自顶向下的,因此从应用的最高层开始建立</p>
<ul>
<li>最高层的是一个注册中心的实现,注册中心的功能是:<code>作为根目录服务器,提供键值对映射,远程服务名称-&gt;(IP,端口)</code>,然后发送数据到此服务器上,服务器执行监听即可</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 存储键值对:rpcServiceName->socketAddress
 * @param rpcServiceName
 * @param socketAddress
 */</span>
<span class="token keyword">void</span> <span class="token function">registerService</span><span class="token punctuation">(</span><span class="token class-name">String</span> rpcServiceName<span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span> socketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么我们如果想要注册服务,那么就必须知道服务器的Ip和端口对吧,然后知道了之后,我们怎么去调用呢?</p>
<blockquote>
<p>使用socket进行通信的核心思路是:远程服务器开启一个主线程监听端口,接收端口的数据,然后根据远程调用的请求信息调用方法,最后返回对象</p>
</blockquote>
<ul>
<li>第二层就是让你实现这样一个服务器</li>
</ul>
<p>分析:首先需要开启一个主线程监听服务,然后在主线程中提交<code>rpc</code>请求。</p>
<p>于是需要:<code>工作者线程池</code>、<code>主线程的业务逻辑</code></p>
<p>于是写出框架如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 主线程开始监听客户端的请求
 * @param port:监听端口号
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">ServerSocket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//1.开启socket,监听port端口</span>
        <span class="token class-name">String</span> host <span class="token operator">=</span> <span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这里使用这个对象是为了更好的获得hostname和port,便于服务的注册</span>
        socket<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.开始监听</span>
        <span class="token class-name">Socket</span> clientSocket<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>clientSocket <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端已经连接,客户端ip:&#123;&#125;"</span><span class="token punctuation">,</span>clientSocket<span class="token punctuation">.</span><span class="token function">getInetAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        workerGroup<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第三步:当客户端和服务端的连接打开后,服务端开始处理客户端发过来的请求,那么我们就需要定义一套逻辑专门用来处理这个连接上的参数</li>
</ul>
<p>于是定义:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SocketRpcRequestHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">SocketRpcRequestHandler</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token operator">=</span> socket<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里带socket是为了让这个线程专门去处理socket</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.从client中获取对方发送的请求</span>

<span class="token comment">//2.将这个请求发送给专门的处理器</span>

<span class="token comment">//3.处理器返回结果</span>

<span class="token comment">//4.将结果写回输出流</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>还需要额外定义一个处理器类来完成结果返回与结果处理的解耦,于是定义</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 处理请求对象
 * @param rpcRequest
 * @return
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span> rpcRequest<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//1.根据服务名称获取具体的服务实现类</span>
    
    <span class="token comment">//2.获取到具体的服务实现类后,根据方法以及参数调用方法</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">invokeMethod</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span> rpcRequest<span class="token punctuation">,</span><span class="token class-name">Object</span> service<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//1.获取方法</span>
        <span class="token class-name">String</span> methodName <span class="token operator">=</span> rpcRequest<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.使用上参数,调用方法</span>
        result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//3.返回结果</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>于是到了这一步,如何根据服务名称获得对应的实现类?</p>
<blockquote>
<p>思路:封装一个服务提供者,里面缓存了当前实例所提供的所有<code>远程服务名称-&gt;服务实现类</code>,然后get出来即可</p>
</blockquote>
<p>为什么要额外封装?这是因为我们的这个类是向外提供服务的,然而这个服务提供者还需要完成服务的注册与推送的功能,因此在此解耦合</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServiceProvider</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 发布新的服务,将服务注册
     * @param rpcServiceConfig
     */</span>
    <span class="token keyword">void</span> <span class="token function">publishService</span><span class="token punctuation">(</span><span class="token class-name">RpcServiceConfig</span> rpcServiceConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 通过远程调用名称获取服务的实现
     * @param rpcServiceName
     * @return
     */</span>
    <span class="token class-name">Object</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">String</span> rpcServiceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后完善处理器代码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span> rpcRequest<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//1.根据服务名称获取具体的服务实现类</span>
    <span class="token class-name">Object</span> service <span class="token operator">=</span> serviceProvider<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2.获取到具体的服务实现类后,根据方法以及参数调用方法</span>
    <span class="token keyword">return</span> <span class="token function">invokeMethod</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">,</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接着回去编写线程任务代码</p>
<p>我们注意到,任务处理器不必每一次都处理一个新的,因为它没有线程安全问题,因此在此创建一个单例工厂</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//存储单例对象</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> singletonMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">SingletonFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>singletonMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> clazz<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span>singletonMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            singletonMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> singletonMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>完整代码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SocketRpcRequestHandlerTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SocketRpcRequestHandler</span> socketRpcRequestHandler<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">SocketRpcRequestHandlerTask</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token operator">=</span> socket<span class="token punctuation">;</span>
        socketRpcRequestHandler <span class="token operator">=</span> <span class="token class-name">SingletonFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">SocketRpcRequestHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"当前处理任务线程:&#123;&#125;"</span><span class="token punctuation">,</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//1.从client中获取对方发送的请求</span>
            <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RpcRequest</span> rpcRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcRequest</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2.将这个请求发送给专门的处理器进行解析和方法的调用</span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> socketRpcRequestHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3.将结果写回输出流</span>
            <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4.完成响应</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>至此,基于<code>Socket</code>实现的RPC远程调用就完成了</p>
<h3 id="3-4-基于Netty实现的RPC远程调用-客户端"><a href="#3-4-基于Netty实现的RPC远程调用-客户端" class="headerlink" title="3.4 基于Netty实现的RPC远程调用(客户端)"></a>3.4 基于Netty实现的RPC远程调用(客户端)</h3><p>在前面<code>Netty</code>入门实战中,我们已经实现了一个基础可用的<code>RPC</code>远程调用程序,但是存在问题</p>
<ul>
<li>没有提供注册中心</li>
<li>客户端和服务器的通信机制单一,无法获得其他服务</li>
</ul>
<p>基于此,我们要做的就是将我们刚才搭的注册中心的框架引入进去。</p>
<p>理顺执行的流程:</p>
<p>第一步:是客户端要通过用户的远程调用服务名称,从中取出服务器的地址</p>
<p>第二步:与对方服务器建立连接</p>
<p>第三步:使用封装好的请求对象进行数据交互</p>
<p>因此,我们需要引入注册中心:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServiceDiscovery</span> serviceDiscovery<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>serviceDiscovery <span class="token operator">=</span> serviceDiscovery<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在连接之前,通过服务端提交过来的<code>请求</code>参数确定服务地址, 然后连接到远程,将东西发送过去就行了</p>
<p>初步修改:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">InetSocketAddress</span> inetSocketAddress <span class="token operator">=</span> serviceDiscovery<span class="token punctuation">.</span><span class="token function">lookUpService</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//1.建立连接,并且获取连接对象数据</span>
    <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样的话就把我们的注册中心引入进来了</p>
<h3 id="3-5-客户端性能分析与优化"><a href="#3-5-客户端性能分析与优化" class="headerlink" title="3.5 客户端性能分析与优化"></a>3.5 客户端性能分析与优化</h3><p>我们先来分析一下当前的代码有什么问题:</p>
<p><strong>第一个问题:通道连接的浪费</strong>,目前我们的客户端处理响应是这样的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">RpcResponse</span> rpcResponse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcResponse</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端读取到的信息为:&#123;&#125;"</span><span class="token punctuation">,</span>rpcResponse<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RpcResponse</span><span class="token punctuation">></span></span> key <span class="token operator">=</span> <span class="token class-name">AttributeKey</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">"rpcResponse"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>也就是说,当服务端传过来一个响应之后,我们就立即关闭掉这个通道了,然后我们看看我们的通道是如何建立的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.建立连接,并且获取连接对象数据</span>
<span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//1.1 获取通道描述对象</span>
<span class="token class-name">Channel</span> channel <span class="token operator">=</span> channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先我们可以看出,建立通道是一个耗时的过程,如果不是耗时的过程也不会需要用到同步阻塞,同时,连接的连接可能会不成功</p>
<blockquote>
<p>既然连接的建立那么费劲,那么我们为什么不复用连接呢?</p>
</blockquote>
<p>在这里,我们的实现思路也是一个基于<code>pooling</code>的基本思路,如果我们发现一条连接依然是有效的,那么我们就复用它,否则删除重建</p>
<ul>
<li>第一步:建立一个<code>Channel</code>管理类,它封装了对<code>Channel</code>的相关操作,包括:判断是否存活,存取<code>Channel</code>等操作</li>
</ul>
<p>编写如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ChannelProvider</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Channel</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> inetSocketAddress<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> inetSocketAddress<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//内部缓存</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Channel</span><span class="token punctuation">></span></span> channelMap<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">ChannelProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    channelMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Channel</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * 通过inetSocketAddress来查找当前是否存在这个隧道
 * @param inetSocketAddress
 * @return
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Channel</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> inetSocketAddress<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Channel</span> channel<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>channelMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//如果存在这个key</span>
        <span class="token comment">//判断隧道还是否有效</span>
        channel <span class="token operator">=</span> channelMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>channel<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> channel<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> channel<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token comment">//否则就已经失效了</span>
            channelMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//否则的话就是压根没这个key</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> inetSocketAddress<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    channelMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    channelMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第二步,在客户端中注入这个对象,并且对获取通道的过程再次封装</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 获取连接对象
 * @param inetSocketAddress
 * @return
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Channel</span> <span class="token function">doConnect</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> inetSocketAddress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">></span></span> completableFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">)</span>future <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端连接服务器成功!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            completableFuture<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"客户端连接服务器失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"客户端连接服务器失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> completableFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token class-name">Channel</span> <span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Channel</span> channel <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//重建连接</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            channel <span class="token operator">=</span> <span class="token function">doConnect</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//然后这个隧道入池</span>
        provider<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">,</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> channel<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>第三步:在业务中引入我们设计的池子,要替换的是这一段</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.建立连接,并且获取连接对象数据</span>
<span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//1.1 获取通道描述对象</span>
<span class="token class-name">Channel</span> channel <span class="token operator">=</span> channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>于是修改为</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token function">getChannel</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>于是这个优化点就结束了</p>
<blockquote>
<p>技术点:通过异步回调的方式获取连接后的通道,避免阻塞式连接,提高性能</p>
</blockquote>
<p>此时,我们的客户端代码也需要修改,我们先来回顾一下之前写的逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>channel<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> channel<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//2.建立连接成功,向通道中写入数据,并且监听发送状态</span>
    channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>future <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端成功发送了信息,请求信息是:&#123;&#125;"</span><span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"客户端发送信息失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3.等待服务端返回信息,当信息传递完毕后通道关闭,因此我们监听通道的存活状态</span>
    channel<span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4.通道关闭,数据应当已经写入到了通道域中</span>
    <span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RpcResponse</span><span class="token punctuation">></span></span> key <span class="token operator">=</span> <span class="token class-name">AttributeKey</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">"rpcResponse"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4.返回信息成功,取出返回值</span>
    <span class="token keyword">return</span> channel<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.获取请求信息</span>
<span class="token class-name">RpcRequest</span> rpcRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcRequest</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到了信息&#123;&#125;,次数:&#123;&#125;"</span><span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">COUNTER</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2.返回调用信息</span>
<span class="token comment">//TODO:在本地发起调用...</span>
<span class="token class-name">RpcResponse</span> rpcResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rpcResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"complete!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//3.向通道中写回信息</span>
<span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
future<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在之前,我们判断数据是否被写入是根据客户端是否正确接收到数据,现在我们选用复用通道,那么就肯定不是一次连接一次关闭了,因此我们的策略是<code>修改通道为不直接关闭</code></p>
<p>于是先初步修改为</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.获取请求信息</span>
<span class="token class-name">RpcRequest</span> rpcRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcRequest</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到了信息&#123;&#125;,次数:&#123;&#125;"</span><span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">COUNTER</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2.返回调用信息</span>
<span class="token comment">//TODO:在本地发起调用...</span>
<span class="token class-name">RpcResponse</span> rpcResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rpcResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"complete!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//3.向通道中写回信息</span>
<span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是这里的话就有一个问题了,就是怎么拿对应的数据出来?</p>
<p>第一种方案:利用我们提供的<code>requestId</code>作为key,存到通道域里面去,代码如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RpcResponse</span><span class="token punctuation">></span></span> key <span class="token operator">=</span> <span class="token class-name">AttributeKey</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RpcResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后对应的客户端从中取出key即可</p>
<p>分析:这种方式存在什么问题?</p>
<p>它的问题主要是串行执行,当客户端想要获取数据的时候,必须串行执行任务,也就是说,当通信线程需要从通道中get到数据的时候,都会被迫因为<code>sync()</code>而被阻塞,但是这是避免不了的,因为只有当对方发出关闭通道的信号的时候,我才能确保这个key被写入了,否则的话必须不断轮询map</p>
<blockquote>
<p>如何解决?</p>
</blockquote>
<p>解决串行同步执行的一般方法是异步执行,那么对谁异步处理呢?</p>
<p>对处理的结果,也就是这个<code>key-value</code>的键值对,我们想要的是<code>RpcResponse</code>这个对象</p>
<ul>
<li>第一步:在客户端发送数据的时候,给这个<code>RpcResponse</code>创建异步回调任务,并且使用容器存储起来</li>
<li>第二步:服务端处理数据,返回<code>RpcResponse</code>到客户端</li>
<li>第三步:客户端接收到这个<code>RpcResponse</code>后,将异步回调任务设置为<code>complete</code></li>
</ul>
<p>由于<code>RpcResponse</code>对象中是否有值,取决于客户端是否处理完这个数据,而只有当客户端去强行<code>get</code>这个对象的时候,如果数据还没有准备好,才会将客户端的线程挂起。</p>
<p>因此是十分灵活的,客户端只需要将请求发送出去,然后返回这个响应所对应的异步任务,当客户端真正需要这个异步任务的结果的时候,才将自己阻塞。</p>
<p>为此,我们使用一个封装对象,这个对象封装了对应的请求的Id和对应的<code>future</code>对象,这个类还应该要提供</p>
<ul>
<li>当客户端能够接收完对象后,能够将这个<code>future</code>给<code>complete</code>,同时删除键值对</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">RpcResponse</span><span class="token punctuation">></span><span class="token punctuation">></span></span> requestMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token class-name">RpcResponse</span> rpcResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RpcResponse</span><span class="token punctuation">></span></span> future <span class="token operator">=</span> requestMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">.</span><span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>future <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"响应并发错误!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//否则的话就将这个future完成掉</span>
    future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestId<span class="token punctuation">,</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RpcResponse</span><span class="token punctuation">></span></span> future<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>requestId<span class="token punctuation">)</span><span class="token punctuation">,</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后我们对客户端进行改造</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RpcResponse</span><span class="token punctuation">></span></span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">RpcRequest</span> rpcRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RpcResponse</span><span class="token punctuation">></span></span> future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InetSocketAddress</span> inetSocketAddress <span class="token operator">=</span> serviceDiscovery<span class="token punctuation">.</span><span class="token function">lookUpService</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token function">getChannel</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>channel<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> channel<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//将当前的请求-响应任务加入到队列中</span>
        <span class="token class-name">UnprocessedRequests</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">.</span><span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.建立连接成功,向通道中写入数据,并且监听发送状态</span>
        channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">)</span>f<span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端发送数据成功&#123;&#125;"</span><span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                future<span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"客户端发送失败,原因:&#123;&#125;"</span><span class="token punctuation">,</span>f<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"通道关闭异常!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> future<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接着是这个客户端处理线程的改动,它要做的是接收到来自服务端的响应,然后把它complete掉</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">RpcResponse</span> rpcResponse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcResponse</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端读取到的信息为:&#123;&#125;"</span><span class="token punctuation">,</span>rpcResponse<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将它complete掉即可</span>
            <span class="token class-name">UnprocessedRequests</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"响应格式不合法!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-6-基于Netty实现的RPC远程调用-服务端"><a href="#3-6-基于Netty实现的RPC远程调用-服务端" class="headerlink" title="3.6 基于Netty实现的RPC远程调用(服务端)"></a>3.6 基于Netty实现的RPC远程调用(服务端)</h3><p>基于3.4和3.5我们对整个网络传输模块进行了异步调用的优化,接着我们完成服务端的改动</p>
<p>服务端是一个操作对象,因此它应该具有暴露一个服务注册的功能,于是我们添加:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registryService</span><span class="token punctuation">(</span><span class="token class-name">RpcServiceConfig</span> rpcServiceConfig<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    serviceProvider<span class="token punctuation">.</span><span class="token function">publishService</span><span class="token punctuation">(</span>rpcServiceConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.获取请求信息</span>
<span class="token class-name">RpcRequest</span> rpcRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcRequest</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到了信息&#123;&#125;,次数:&#123;&#125;"</span><span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">COUNTER</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2.返回调用信息</span>
<span class="token comment">//TODO:在本地发起调用...</span>
<span class="token class-name">RpcResponse</span> rpcResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rpcResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"complete!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//3.向通道中写回信息</span>
<span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
future<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE_ON_FAILURE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-自定义通信协议"><a href="#4-自定义通信协议" class="headerlink" title="4. 自定义通信协议"></a>4. 自定义通信协议</h2><h3 id="4-1-通信协议设计"><a href="#4-1-通信协议设计" class="headerlink" title="4.1 通信协议设计"></a>4.1 通信协议设计</h3><p>目前来说,我们所实现的这个rpc框架还不需要用到通信协议</p>
<p>但是我们的<code>rpc</code>框架最终是在分布式的环境下进行通信的,假设是<code>Java</code>客户端与<code>golang</code>客户端进行通信,<code>JDK</code>所提供的序列化方式是<code>golang</code>客户端所不知道的,因此我们必须在通信协议的头部添加一个标记,规定双方使用什么样的方式来对数据进行解释,这就是通信协议存在的意义</p>
<p>我们设计的通信协议如下:</p>
<ul>
<li><p>魔数:magicCode:四字节,32bit,用来生成一个协议标志,拿到数据包后会先检查这个魔数,如果魔数合法,那么就继续解析,否则丢弃数据包</p>
</li>
<li><p>版本号version:占1个字节,表示通信协议的版本号,当协议发生变化时,对等端的协议解析器也要修改相关解析代码,因此需要校验版本号后才能进行解析,否则丢弃数据包</p>
</li>
<li><p>消息长度full-length:占4个字节,表示当前消息的body的长度,这个问题解决了底层TCP的半包和粘包的问题</p>
</li>
<li><p>消息类型message-type,占1个字节:分别为 </p>
<ul>
<li>请求消息类型</li>
<li>响应消息类型</li>
<li>心跳检测消息类型</li>
</ul>
</li>
<li><p>序列化方式codec,占1个字节,其中不同的编码代表不同解析方式状态机</p>
</li>
</ul>
<blockquote>
<p>以下是基于HTTP&#x2F;2实现的头部&#x2F;首部压缩的添加字段</p>
</blockquote>
<ul>
<li>消息压缩方式compress:占1个字节</li>
<li>请求ID(StreamId)requestID:4个字节</li>
</ul>
<h3 id="4-2-添加客户端封装成帧-包-代码"><a href="#4-2-添加客户端封装成帧-包-代码" class="headerlink" title="4.2 添加客户端封装成帧(包)代码"></a>4.2 添加客户端封装成帧(包)代码</h3><p>首先我们先将一些定义添加到我们的常量池中</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAGIC_NUMBER</span> <span class="token operator">=</span> <span class="token number">114514</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">VERSION</span> <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">RESPONSE_MESSAGE</span> <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">REQUEST_MESSAGE</span>  <span class="token operator">=</span> <span class="token number">0x2</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">HEARTBEAT_MESSAGE</span> <span class="token operator">=</span> <span class="token number">0x3</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">KRYO_CODEC</span> <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">GZIP_COMPRESS</span> <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后封装一个协议包的对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcMessage</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * 消息类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span> messageType<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 序列化类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span> codec<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 压缩方式
     */</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span> compress<span class="token punctuation">;</span>

    <span class="token comment">/**
     * request id
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> requestId<span class="token punctuation">;</span>
    <span class="token comment">/**
     * request data
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于剩下的字段都是在运行时计算得出的,或者是固定常量,因此在<code>encoder</code>里面写</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> channelHandlerContext<span class="token punctuation">,</span><span class="token class-name">RpcPackage</span> rpcPackage<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>genericClass<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>rpcPackage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//1.写入魔数(4B->INT)</span>
        out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token constant">MAGIC_NUMBER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.写入版本号1B</span>
        out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token constant">VERSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.写入数据长度4B</span>
        out<span class="token punctuation">.</span><span class="token function">markWriterIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4.写入数据类型message,1B</span>
        out<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>rpcPackage<span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.写入序列化方式,1B</span>
        out<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>rpcPackage<span class="token punctuation">.</span><span class="token function">getCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//6.写入消息压缩格式,1B</span>
        out<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>rpcPackage<span class="token punctuation">.</span><span class="token function">getCompress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//7.写入请求ID(4B->INT)</span>
        out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>rpcPackage<span class="token punctuation">.</span><span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//TODO:数据压缩未完成</span>
        <span class="token comment">//TODO:这里还有数据的长度没有设置的,由于存在数据的压缩,因此这里还需要做一个数据的压缩(包体)</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serialize <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>rpcPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fullLength <span class="token operator">=</span> serialize<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token constant">HEADER_LENGTH</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>serialize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.回去写入这个数据</span>
        out<span class="token punctuation">.</span><span class="token function">resetWriterIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>fullLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//序列化完成</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来,在客户端中封装这个帧即可</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//重新封装</span>
            <span class="token comment">//消息类型、序列化协议、压缩类型、请求Id、请求数据:包体</span>
            <span class="token class-name">RpcPackage</span> rpcPackage <span class="token operator">=</span> <span class="token class-name">RpcPackage</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">messageType</span><span class="token punctuation">(</span><span class="token constant">REQUEST_MESSAGE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">codec</span><span class="token punctuation">(</span><span class="token constant">KRYO_CODEC</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span><span class="token constant">GZIP_COMPRESS</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">requestId</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">.</span><span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcPackage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">)</span>f<span class="token operator">-></span> <span class="token punctuation">&#123;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-3-添加服务端解析包头代码"><a href="#4-3-添加服务端解析包头代码" class="headerlink" title="4.3 添加服务端解析包头代码"></a>4.3 添加服务端解析包头代码</h3><p>服务端首先接收到数据后要先进行包的拆解和对象的还原,因此修改<code>Encoder</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>byteBuf <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> byteBuf<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token constant">BODY_LENGTH</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"参数不合法!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
byteBuf<span class="token punctuation">.</span><span class="token function">markReaderIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//1.检查魔数</span>
<span class="token keyword">int</span> magicNumber <span class="token operator">=</span> byteBuf<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>magicNumber <span class="token operator">!=</span> <span class="token constant">MAGIC_NUMBER</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"魔数错误!不是当前协议的包"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//2.检查版本</span>
<span class="token keyword">byte</span> version <span class="token operator">=</span> byteBuf<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>version <span class="token operator">!=</span> <span class="token constant">VERSION</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"协议版本号不一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//3.读取数据长度</span>
<span class="token keyword">int</span> fullLength <span class="token operator">=</span> byteBuf<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//4.读取数据的类型</span>
<span class="token keyword">byte</span> messageType <span class="token operator">=</span> byteBuf<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//5.读取序列化方式</span>
<span class="token keyword">byte</span> codec <span class="token operator">=</span> byteBuf<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//6.读取消息压缩格式</span>
<span class="token keyword">byte</span> compress <span class="token operator">=</span> byteBuf<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//7.获取请求ID</span>
<span class="token keyword">int</span> requestId <span class="token operator">=</span> byteBuf<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RpcPackage</span> rpcPackage <span class="token operator">=</span> <span class="token class-name">RpcPackage</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">codec</span><span class="token punctuation">(</span>codec<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">messageType</span><span class="token punctuation">(</span>messageType<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span>compress<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">requestId</span><span class="token punctuation">(</span>requestId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*处理body部分*/</span>
<span class="token keyword">int</span> bodyLength <span class="token operator">=</span> fullLength <span class="token operator">-</span> <span class="token constant">HEADER_LENGTH</span><span class="token punctuation">;</span>
<span class="token comment">//1.如果body是空体</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>bodyLength <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//2.如果body中的字节数小于规定的数量</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>bodyLength <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    byteBuf<span class="token punctuation">.</span><span class="token function">resetReaderIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"出现半包现象,等待下一次I/O读取完整数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//3.正常情况或者整包</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>bodyLength<span class="token punctuation">]</span><span class="token punctuation">;</span>
byteBuf<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//TODO:这里可以做一个包的展开</span>
<span class="token class-name">Object</span> result <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>genericClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"反序列化完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后修改发送响应的逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">RpcPackage</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">RpcPackage</span> rpcPackage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcPackage</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            <span class="token class-name">RpcRequest</span> rpcRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcRequest</span><span class="token punctuation">)</span> rpcPackage<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到了信息&#123;&#125;,次数:&#123;&#125;"</span><span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">COUNTER</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RpcPackage</span> rpcResponse <span class="token operator">=</span> <span class="token class-name">RpcPackage</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">requestId</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">.</span><span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">codec</span><span class="token punctuation">(</span><span class="token constant">KRYO_CODEC</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span><span class="token constant">GZIP_COMPRESS</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">messageType</span><span class="token punctuation">(</span><span class="token constant">RESPONSE_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3.向通道中写回信息</span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> rpcRequestHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rpcResponse<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE_ON_FAILURE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>至此,一个完整的具有自定义通信协议的RPC远程调用就被完成了</p>
<h2 id="5-心跳机制"><a href="#5-心跳机制" class="headerlink" title="5. 心跳机制"></a>5. 心跳机制</h2><h3 id="5-1-心跳机制简述-为什么"><a href="#5-1-心跳机制简述-为什么" class="headerlink" title="5.1 心跳机制简述(为什么)"></a>5.1 心跳机制简述(为什么)</h3><p><strong>什么是心跳</strong></p>
<p>在TCP连接中,在客户端和服务端建立连接之后,需要定期发送数据包,来通知对方自己还在线,以确保连接的有效性,如果一个连接上时间没有心跳,需要及时断开,否则服务端会维护很多很多无用的连接,浪费服务器的资源</p>
<p>简单来说,我们在之前做客户端性能分析与优化的时候,我们并没有设置通道啥时候关闭,它是否关闭取决于这条TCP连接什么时候失效,因此为了避免连接被操作系统回收,那么我们必须定时在这条连接上发送数据包,否则这条连接因为闲置就会被回收。</p>
<blockquote>
<p>心跳的好处</p>
<ul>
<li>提供了保活的思路,避免连接被频繁回收导致高成本的连接与释放的开销</li>
<li>提供了检测条件,能够检测连接是否还存在</li>
</ul>
</blockquote>
<p><strong>IdleStateHandler</strong></p>
<p>Netty 已经为我们提供了心跳的 Handler,当连接的空闲时间太长的时候,就会触发一个<code>IdleStateEvent</code>事件,传递到下一个<code>Handler</code>,可以通过<code>PipleHandler</code>中重写<code>userEventTrigged</code>来处理该事件,注意我们自己的 Handler 需要在 <code>IdleStateHandler</code> 后面。</p>
<h3 id="5-2-IdleStateHandler"><a href="#5-2-IdleStateHandler" class="headerlink" title="5.2 IdleStateHandler"></a>5.2 IdleStateHandler</h3><p>IdleStateHandler构造函数解读</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> observeOutput<span class="token punctuation">,</span>
            <span class="token keyword">long</span> readerIdleTime<span class="token punctuation">,</span> <span class="token keyword">long</span> writerIdleTime<span class="token punctuation">,</span> <span class="token keyword">long</span> allIdleTime<span class="token punctuation">,</span>
            <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>observeOutput:是否考虑出站较慢的情况,如果 true：当出站时间太长，超过空闲时间，那么将不触发此次事件。如果 false，超过空闲时间就会触发事件。默认 false。</li>
<li>readerIdleTime:读空闲的时间，0 表示禁用读空闲事件。</li>
<li>writerIdleTime:写空闲的时间，0 表示禁用写空闲事件。</li>
<li>allIdleTime:读或写空闲的时间，0 表示禁用事件。</li>
<li>unit:单位</li>
</ul>
<p><strong>事件处理机制</strong></p>
<p><code>IdleStateHandler</code> 继承 <code>ChannelDuplexHandler</code>，重写了出站和入站的事件，我们来看看代码。<br>当 channel 添加、注册、活跃的时候，会初始化 <code>initialize(ctx)</code>，删除、不活跃的时候销毁 <code>destroy()</code>，读写的时候设置 <code>lastReadTime</code> 和 <code>lastWriteTime</code> 字段。</p>
<p><strong>初始化</strong></p>
<p>当 channel 添加、注册、活跃的时候，会初始化 <code>initialize(ctx)</code>，下面我们就来看看初始化的代码：</p>
<p>其实初始化很简单，就是根据构造函数给的 读写空闲时间 去决定初始化哪些<strong>定时任务</strong>，分别是：<code>ReaderIdleTimeoutTask</code>(读空闲超时任务)、<code>WriterIdleTimeoutTask</code>(写空闲超时任务)、<code>AllIdleTimeoutTask</code>(读写空闲超时任务)。</p>
<p><strong>定时任务</strong><br>① 如果读空闲超时了，则重新起一个定时器，然后触发事件<br>② 如果读空闲未超时，则新起一个时间更短(<code>readerIdleTimeNanos - ticksInNanos() - lastReadTime</code>)的定时器</p>
<p><strong>触发事件</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeUserEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">Object</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 触发事件，说白了，就是直接调用 userEventTriggered 方法而已</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelInboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">userEventTriggered</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">notifyHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其实触发事件，就是把事件传给<strong>下一个</strong> Handler (<code>next</code>)，就是调用 <code>userEventTriggered</code> 方法而已。所以我们处理心跳的 Handler 一定要写到 <code>IdleStateHandler</code>。</p>
<h3 id="5-3-客户端实现"><a href="#5-3-客户端实现" class="headerlink" title="5.3 客户端实现"></a>5.3 客户端实现</h3><p>首先我们先将这个<code>闲置时间检测</code>的处理器注册到引导器上</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后当这个事件触发的时候,调用的是<code>handler</code>中的<code>userEventTriggered</code>方法,因此我们进行重写</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>evt <span class="token keyword">instanceof</span> <span class="token class-name">IdleStateEvent</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//当传来一个事件的时候</span>
        <span class="token class-name">IdleStateEvent</span> idleStateEvent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IdleStateEvent</span><span class="token punctuation">)</span> evt<span class="token punctuation">;</span>
        <span class="token comment">//写空闲</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IdleStateEvent</span><span class="token punctuation">)</span> evt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">IdleState</span><span class="token punctuation">.</span><span class="token constant">WRITER_IDLE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"写空闲时间触发 [&#123;&#125;]"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Channel</span> channel <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//向通道中发送心跳</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的话我们思考一下,心跳到底要如何交流?</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">HEARTBEAT_REQUEST_MESSAGE</span> <span class="token operator">=</span> <span class="token number">0x3</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> <span class="token constant">HEARTBEAT_RESPONSE_MESSAGE</span> <span class="token operator">=</span> <span class="token number">0x4</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PING</span> <span class="token operator">=</span> <span class="token string">"PING"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PONG</span> <span class="token operator">=</span> <span class="token string">"PONG"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>思路是这样的,发送心跳的一方为心跳请求方,它发送一个<code>PING</code>出去,如果对方给我发来<code>PONG</code>,就说明这条连接是可用的</p>
<p>补充事件处理器</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IdleStateEvent</span><span class="token punctuation">)</span> evt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">IdleState</span><span class="token punctuation">.</span><span class="token constant">WRITER_IDLE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"写空闲时间触发 [&#123;&#125;]"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Channel</span> channel <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//向通道中发送心跳</span>
    <span class="token class-name">RpcPackage</span> rpcPackage <span class="token operator">=</span> <span class="token class-name">RpcPackage</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span><span class="token constant">DUMMY_COMPRESS</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">codec</span><span class="token punctuation">(</span><span class="token constant">KRYO_CODEC</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token constant">PING</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">messageType</span><span class="token punctuation">(</span><span class="token constant">HEARTBEAT_REQUEST_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">userEventTriggered</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>补充线程处理器</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">RpcPackage</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">RpcPackage</span> rpcMessage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcPackage</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            <span class="token keyword">byte</span> messageType <span class="token operator">=</span> rpcMessage<span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>messageType <span class="token operator">==</span> <span class="token constant">RESPONSE_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端读取到的信息为:&#123;&#125;"</span><span class="token punctuation">,</span>rpcMessage<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将它complete掉即可</span>
                <span class="token class-name">UnprocessedRequests</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RpcResponse</span><span class="token punctuation">)</span> rpcMessage<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>messageType <span class="token operator">==</span> <span class="token constant">HEARTBEAT_RESPONSE_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到心跳&#123;&#125;"</span><span class="token punctuation">,</span>rpcMessage<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"响应格式不合法!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-4-服务端实现"><a href="#5-4-服务端实现" class="headerlink" title="5.4 服务端实现"></a>5.4 服务端实现</h3><p>服务端的话,实际上有两种情况,一种是收到心跳包后响应,一种是收到心跳包后不响应</p>
<p>首先第一种是就是强维护,这种心跳包是为了保证连接一直存活不断开</p>
<p>第二种是弱维护,这种心跳包就是为了释放资源,找到合适的时机将连接断开</p>
<p>这里的话我们实现第一种,<code>PING-PONG</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">RpcPackage</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">RpcPackage</span> rpcPackage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcPackage</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token class-name">RpcRequest</span> rpcRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcRequest</span><span class="token punctuation">)</span> rpcPackage<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到了信息&#123;&#125;,次数:&#123;&#125;"</span><span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">COUNTER</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//分情况讨论,分别是心跳包和非心跳包</span>
        <span class="token class-name">RpcPackage</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setCodec</span><span class="token punctuation">(</span><span class="token constant">KRYO_CODEC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setCompress</span><span class="token punctuation">(</span><span class="token constant">GZIP_COMPRESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span> messageType <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RpcPackage</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>messageType <span class="token operator">==</span> <span class="token constant">HEARTBEAT_REQUEST_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//响应pong</span>
            response<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token constant">PONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setMessageType</span><span class="token punctuation">(</span><span class="token constant">HEARTBEAT_RESPONSE_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>messageType <span class="token operator">==</span> <span class="token constant">REQUEST_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            response<span class="token punctuation">.</span><span class="token function">setRequestId</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">.</span><span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setMessageType</span><span class="token punctuation">(</span><span class="token constant">RESPONSE_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> rpcRequestHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token class-name">RpcResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> rpcResponse <span class="token operator">=</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span>rpcRequest<span class="token punctuation">.</span><span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                rpcPackage<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token class-name">RpcResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> rpcResponse <span class="token operator">=</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>rpcRequest<span class="token punctuation">.</span><span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                rpcPackage<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>rpcResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>rpcPackage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE_ON_FAILURE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java">socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>实际上第二种也能够保证连接不断开,因为连接是否要断开取决于服务端</p>
</blockquote>
<p>这时候,如果客户端的包长时间到不来服务端,但是实际上这条连接还是在工作的,那么这时候就要使用重连机制了</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Channel</span> <span class="token function">doConnect</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> inetSocketAddress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">></span></span> completableFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">)</span>future <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"客户端连接服务器成功!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            completableFuture<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"客户端连接服务器失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token string">"客户端连接服务器失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> completableFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token class-name">Channel</span> <span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Channel</span> channel <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//重建连接</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            channel <span class="token operator">=</span> <span class="token function">doConnect</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//然后这个隧道入池</span>
        provider<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">,</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> channel<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>






















                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">穿山甲</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://lumxi.github.io/2023/02/06/Java-work/rpc-2/">https://lumxi.github.io/2023/02/06/Java-work/rpc-2/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">穿山甲</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Java/">
                                    <span class="chip bg-color">Java</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/02/07/Mysql-basic/Mysql-basic-05/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="Mysql-深入锁机制">
                        
                        <span class="card-title">Mysql-深入锁机制</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-02-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Mysql/" class="post-category">
                                    Mysql
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%90%8E%E7%AB%AF/">
                        <span class="chip bg-color">后端</span>
                    </a>
                    
                    <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                        <span class="chip bg-color">数据库</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/02/06/Java-work/rpc-4/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="从零开始实现一个简单的RPC框架(4)">
                        
                        <span class="card-title">从零开始实现一个简单的RPC框架(4)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-02-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/java%E5%9F%BA%E7%A1%80/" class="post-category">
                                    java基础
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">穿山甲</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
